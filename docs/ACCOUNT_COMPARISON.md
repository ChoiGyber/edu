# 🔐 서버 계정 선택 가이드

## 계정 선택 비교표

| 항목 | Root 사용 | 일반 계정 (ubuntu) | 전용 배포 계정 (deploy) |
|------|----------|------------------|------------------------|
| **보안성** | ⚠️ 매우 높은 위험 | ⚠️ 높은 위험 | ✅ 최적 (최소 권한) |
| **감시/감사** | ❌ 어려움 | ❌ 어려움 | ✅ 명확한 추적 |
| **권한 관리** | ❌ 제어 불가 | ⚠️ sudo 권한 확인 필요 | ✅ 정밀한 제어 |
| **팀 협업** | ⚠️ 혼란 초래 | ⚠️ 활동 구분 어려움 | ✅ 역할 분명 |
| **실수 방지** | ❌ 최악의 영향 | ⚠️ 큰 영향 | ✅ 영향 제한 |
| **설정 복잡도** | ✅ 간단함 | ✅ 간단함 | ⚠️ 약간 복잡 |
| **업계 표준** | ❌ 권장 안 함 | ⚠️ 임시용만 | ✅ 권장 |

---

## 각 계정의 상세 비교

### 1. Root 계정으로 배포

#### 장점
- 설정이 간단함
- 모든 명령 실행 가능

#### 단점
```
⚠️ CRITICAL: 절대 권장하지 않음!

- 보안: GitHub Actions 키가 유출되면 전체 서버 장악
- 감시: 누가 배포했는지 추적 불가능
- 신뢰: 팀 협업에서 책임 불명확
- 사고: 실수 시 전체 시스템 손상
```

#### 사용 시나리오
- 개인 테스트 서버 (단기간)
- 프로토타입 개발만
- 본격 운영은 절대 안 됨

---

### 2. 기존 일반 계정 (ubuntu, www-data 등)

#### 장점
- 대부분의 서버에 이미 존재
- 추가 계정 생성 불필요

#### 단점
```
⚠️ 높은 위험: 권장하지 않음

- 보안: 다른 애플리케이션과 권한 공유
- 감시: 배포 활동과 다른 활동이 섞임
- 혼란: 누가 어떤 권한으로 뭘 했는지 불명확
- 운영: 데이터베이스 접근, 파일 수정 등이 섞임
```

#### 사용 시나리오
- 개인 프로젝트 (중소 규모)
- 보안이 덜 중요한 경우
- 초기 개발/테스트 단계

---

### 3. 전용 배포 계정 (deploy)

#### 장점
```
✅ 업계 표준: 강력히 권장!

- 보안: 최소 권한 원칙 (Principle of Least Privilege)
  → 배포만 가능, 다른 시스템 접근 불가
  
- 감시: 모든 배포 활동 추적 가능
  → 누가, 언제, 뭘 배포했는지 명확
  → /var/log/auth.log에 기록됨
  
- 팀 협업: 역할이 분명함
  → GitHub Actions = deploy 계정
  → 다른 관리자 = 다른 계정
  
- 책임: 배포 관련 문제 추적 용이
  → PM2 로그 분리
  → deploy 계정의 활동만 기록
  
- 운영: 다른 서비스와 격리
  → Nginx, Redis, PostgreSQL 등과 분리
  → 한 계정의 문제가 다른 서비스에 영향 없음
```

#### 단점
- 초기 설정이 조금 복잡함 (약 15분)
- SSH 공개 키 관리 필요

#### 사용 시나리오
- ✅ 모든 본격 프로덕션 서버
- ✅ 팀이 있는 경우
- ✅ 장기 운영 예정
- ✅ 보안이 중요한 경우

---

## 🎯 권장 사항

### 개인 프로젝트 (취미/학습)
```
Phase 1: 개발 중 (테스트 서버)
→ Root 또는 ubuntu 계정 사용 (빠른 설정)

Phase 2: 본격 운영 (프로덕션)
→ deploy 계정 사용 (보안 강화)
```

### 팀 프로젝트 / 상업용 서비스
```
처음부터 deploy 계정 사용 (필수)
→ 책임 추적 가능
→ 보안 감시 용이
→ 나중에 변경하기 어려움
```

### 현재 ubuntu 계정으로 운영 중인 경우
```
Step 1: deploy 계정 생성
Step 2: SSH 키 등록
Step 3: GitHub Secrets 변경
Step 4: 첫 배포 테스트
Step 5: 정상 작동 확인 후 ubuntu 계정 삭제 (선택사항)
```

---

## 변경 비용 비교

### Root → deploy (권장 변경)
| 항목 | 비용 |
|------|------|
| 설정 시간 | 15분 |
| 위험도 | 낮음 (충돌 없음) |
| 롤백 | 쉬움 |

### ubuntu → deploy (비용)
| 항목 | 비용 |
|------|------|
| 설정 시간 | 10분 |
| 위험도 | 매우 낮음 |
| 롤백 | 매우 쉬움 |

---

## 보안 측면

### 개인 정보 보호 관점
```
deploy 계정의 장점:

1. 데이터 격리
   - deploy 계정은 응용 프로그램 파일만 접근 가능
   - /etc/passwd, /root 등 시스템 파일 접근 불가능

2. 감사 추적 (Audit Trail)
   - 모든 배포 활동이 로그에 기록됨
   - 문제 발생 시 원인 파악 용이

3. 권한 제한
   - PM2 재시작만 가능
   - Nginx 설정 변경 불가
   - 데이터베이스 접근 불가
```

---

## 마이그레이션 경로

### 현재: ubuntu 계정 → 목표: deploy 계정

```mermaid
graph LR
A["ubuntu 계정<br/>(현재 사용 중)"] -->|1. deploy 계정 생성| B["deploy 계정<br/>(새로 설정)"]
B -->|2. SSH 키 등록| C["SSH 공개 키<br/>(authorized_keys)"]
C -->|3. GitHub Secrets 변경| D["DEPLOY_KEY<br/>(GitHub)"]
D -->|4. 첫 배포 테스트| E["배포 성공<br/>(검증)"]
E -->|5. ubuntu 제거| F["deploy 계정만<br/>(운영)"]

style A fill:#ffe6e6
style F fill:#e6ffe6
```

### 마이그레이션 체크리스트

```bash
# 1. deploy 계정 생성
sudo useradd -m -s /bin/bash deploy

# 2. SSH 키 등록
sudo mkdir -p /home/deploy/.ssh
# ... (공개 키 등록)

# 3. 프로젝트 복사
sudo cp -r /home/ubuntu/projects /home/deploy/
sudo chown -R deploy:deploy /home/deploy/projects

# 4. GitHub Secrets 변경
# DEPLOY_KEY 추가
# SERVER_USER를 deploy로 변경

# 5. 배포 테스트
git push origin main

# 6. 검증
pm2 logs edu
curl https://your-domain.com/api/health

# 7. 옛 계정 정리 (선택사항)
sudo userdel -r ubuntu
```

---

## FAQ

### Q: 기존 ubuntu 계정과 deploy 계정 모두 사용 가능?
A: 가능하지만 권장하지 않습니다. GitHub Actions는 deploy 계정으로만 배포하고, 관리자 작업은 다른 계정으로 하는 것이 권장됩니다.

### Q: deploy 계정의 비밀번호는?
A: SSH 키 기반 인증이므로 비밀번호 불필요. 필요시 `sudo passwd deploy`로 설정 가능.

### Q: sudo 권한이 없으면 어떻게?
A: `visudo` 파일에서 필요한 명령만 권한 부여. PM2 재시작 정도만 충분함.

### Q: deploy 계정이 해킹되면?
A: GitHub Secret이 유출되지 않는 한, 배포 기능만 제한되고 다른 시스템 손상 없음.

### Q: 팀 멤버가 여러 명이면?
A: 각 자동화 도구마다 별도 계정 생성 가능 (github-actions, gitlab-ci, jenkins 등)

---

## 결론

| 상황 | 권장 계정 |
|------|----------|
| 개인 학습/테스트 | Root 또는 ubuntu (임시) |
| 개인 프로덕션 | **deploy (필수)** |
| 팀 운영 | **deploy (필수)** |
| 상업 서비스 | **deploy (필수)** + 감사 로깅 |

**🎯 결론: 처음부터 deploy 계정으로 설정하는 것을 권장합니다.**

이유:
- 5분의 추가 설정으로 장기간의 보안 확보
- 나중에 변경하기가 어려움
- 팀 규모가 커질 때 필수
